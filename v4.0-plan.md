# v4.0 Plan: ICT Crypto Optimizasyonu

## Mevcut Durum (v3.7)
| Metrik | Değer | Sorun |
|--------|-------|-------|
| Win Rate | 3/4 = 75% | Küçük örneklem |
| Cancel Oranı | 16/20 = **%80** | LIMIT emir dolmuyor |
| Avg Win | +0.67% | Çok düşük |
| Avg Loss | -2.19% | Win'in 3 katı |
| Total PnL | **-0.17%** | Kazanıyorsun ama zarar büyük |
| Promote Rate | 65% | İyi |
| Trade/gün | ~4 | Çok az |

### Cancel Analizi
- 16/16 cancelled = hepsi **3h LIMIT timeout**
- Hiçbir LIMIT emir dolmadı (pullback FVG'ye gelmedi)
- MARKET girilen 4 işlem: 3 WON, 1 LOST

### SL/TP Analizi
- Çoğu SL: %0.26-%0.75 → noise'tan patlıyor
- Çoğu TP: %0.26-%0.52 → spread+fee seviyesinde, kâr yok
- RR filtresi yok → RR=0.26 gibi garanti kayıp sinyaller var

---

## v4.0 Değişiklikler

### 1. LIMIT → MARKET Giriş (En Kritik)
**Dosya:** `trade_manager.py`

Şimdi:
```
5/5 gate → 15dk izleme → LIMIT emir → pullback bekle → %80 cancel
```

Yeni:
```
3/5 gate → 15dk izleme → MARKET giriş → anında işlem
```

- Tüm entry_mode = "MARKET"
- LIMIT emir kodunu kaldır veya devre dışı bırak
- _check_waiting_signal artık LIMIT beklemeyecek

### 2. Min 3/5 Gate ile İzleme Alması
**Dosya:** `ict_strategy.py`

Şimdi:
```
Gate 1 (HTF Bias) ✓
Gate 2 (Premium/Discount) ✓
Gate 3 (Liquidity Sweep) ✓
Gate 4 (Displacement+MSS) ✓  ← Bunları bekle
Gate 5 (FVG) ✓                ← Bunları bekle
= 5/5 gate → SIGNAL
```

Yeni:
```
Gate 1 (HTF Bias) ✓
Gate 2 (Premium/Discount) ✓
Gate 3 (Liquidity Sweep) ✓
= 3/5 gate → SIGNAL (yeterli!)

Gate 4-5 sonra gelirse → açık işlemin SL'sini daralt
```

Gate 1+2+3 = "tuzak kuruldu" sinyali. Displacement (Gate 4) hareketin kendisi = çok geç.

#### SL Daraltma (Açık İşlemde)
```python
# İşlem açıkken Gate 4 (displacement) gelirse:
#   → SL'yi displacement candle'ının altına/üstüne taşı
# İşlem açıkken Gate 5 (FVG) gelirse:
#   → SL'yi FVG'nin altına/üstüne taşı
```

### 3. Min SL Mesafesi %0.5 → %1.0
**Dosya:** `config.py`

```python
# Eski
"min_sl_distance_pct": 0.005,  # %0.5

# Yeni
"min_sl_distance_pct": 0.010,  # %1.0
```

Normal crypto noise %0.3-0.5 → %1.0 SL bu noise'u absorbe eder.

### 4. Min RR 1.5:1 Filtresi
**Dosya:** `trade_manager.py` → `_open_trade()`

```python
# Yeni filtre ekle
tp_distance = abs(tp - entry) / entry
sl_distance = abs(entry - sl) / entry
rr_ratio = tp_distance / sl_distance if sl_distance > 0 else 0

if rr_ratio < 1.5:
    return {"status": "REJECTED", "reason": f"RR çok düşük: {rr_ratio:.2f}"}
```

Bu, TP=%0.26 / SL=%0.51 (RR=0.5) gibi garanti kayıp sinyalleri engeller.

### 5. Breakeven Eşiklerini Gevşet
**Dosya:** `trade_manager.py` → `_manage_long_sl()` ve `_manage_short_sl()`

| Seviye | Şimdi | Yeni |
|--------|-------|------|
| Erken Koruma | %25 | **Kaldır** |
| Breakeven | %40 | **%50** |
| Trailing | %60 | **%70** |

Erken koruma noise yüzünden çok erken tetikleniyor ve kârlı trade'leri öldürüyor.

### 6. Max Concurrent Trades 2 → 3
**Dosya:** `config.py`

```python
# Eski
"max_concurrent_trades": 2,

# Yeni
"max_concurrent_trades": 3,
```

Daha fazla trade = daha fazla data = optimizer daha hızlı öğrenir.

---

## Değişecek Dosyalar

| Dosya | Değişiklik |
|-------|-----------|
| `config.py` | min_sl %1.0, max_concurrent 3 |
| `ict_strategy.py` | 3/5 gate yeterli → SIGNAL, gate_level bilgisi ekle |
| `trade_manager.py` | MARKET giriş, RR filtresi, BE gevşet, SL daraltma |

---

## Beklenen Sonuç

| Metrik | Şimdi (v3.7) | v4.0 Tahmini |
|--------|-------------|-------------|
| Trade/gün | ~4 | ~15-20 |
| Cancel oranı | %80 | ~%0 |
| Min SL | %0.26 | %1.0 |
| Min RR | 0.26 | 1.5 |
| Avg Win | +0.67% | +1.5-2.0% |
| Avg Loss | -2.19% | -1.5% |
| Win Rate | 75% (4 trade) | ~50-60% (data ile artacak) |

---

## Notlar
- LIMIT emir kodu tamamen kaldırılmayacak, sadece devre dışı bırakılacak (gelecekte gerekebilir)
- SL daraltma (Gate 4/5 sonra gelirse) yeni bir fonksiyon olacak: `_tighten_sl_on_gate_completion()`
- Optimizer hâlâ çalışacak ama daha fazla data ile daha iyi kararlar verecek
- İlk 50 trade sonrası performans değerlendirilecek
